###############################################################
# app.py â€” å¡”æœ¨å¾·ç­–ç•¥ (Talmud Strategy) å›æ¸¬ç³»çµ±
# ä¸‰åˆ†æ³•ï¼šä¸å‹•ç”¢ / è‚¡ç¥¨ / ç¾é‡‘
###############################################################

import os
import datetime as dt
import numpy as np
import pandas as pd
import streamlit as st
import matplotlib
import matplotlib.font_manager as fm
import plotly.graph_objects as go
from pathlib import Path
import sys



###############################################################
# å­—å‹è¨­å®š
###############################################################
font_path = "./NotoSansTC-Bold.ttf"
if os.path.exists(font_path):
    fm.fontManager.addfont(font_path)
    matplotlib.rcParams["font.family"] = "Noto Sans TC"
else:
    matplotlib.rcParams["font.sans-serif"] = ["Microsoft JhengHei", "PingFang TC", "Heiti TC"]
matplotlib.rcParams["axes.unicode_minus"] = False

###############################################################
# Streamlit é é¢è¨­å®š
###############################################################
st.set_page_config(page_title="å¡”æœ¨å¾·ç­–ç•¥å›æ¸¬", page_icon="âš–ï¸", layout="wide")

with st.sidebar:
    st.page_link("Home.py", label="å›åˆ°æˆ°æƒ…å®¤", icon="ğŸ ")
    st.divider()
    st.markdown("### ğŸ”— å¿«é€Ÿé€£çµ")
    st.page_link("https://hamr-lab.com/", label="å›åˆ°å®˜ç¶²é¦–é ", icon="ğŸ ")

st.markdown("<h1 style='margin-bottom:0.5em;'>âš–ï¸ å¡”æœ¨å¾·è³‡ç”¢é…ç½® (Talmud Strategy)</h1>", unsafe_allow_html=True)
st.markdown("""
<b>çŒ¶å¤ªç¶“å…¸ã€Šå¡”æœ¨å¾·ã€‹æ™ºæ…§ï¼šå°‡è³‡ç”¢åˆ†ç‚ºä¸‰ç­‰ä»½ã€‚</b><br>
1ï¸âƒ£ <b>ä¸å‹•ç”¢ (Real Estate)</b>ï¼šå¦‚ REITS (VNQ)<br>
2ï¸âƒ£ <b>è‚¡ç¥¨äº‹æ¥­ (Stocks)</b>ï¼šå¦‚ å¤§ç›¤æŒ‡æ•¸ (QQQ, SPY)<br>
3ï¸âƒ£ <b>ç¾é‡‘ (Cash)</b>ï¼šå¦‚ çŸ­æœŸåœ‹å‚µ (BIL, SHV) æˆ–å®šå­˜<br>
<small>ç­–ç•¥æ ¸å¿ƒï¼šå®šæœŸå°‡ä¸‰å€‹ç±ƒå­çš„è³‡é‡‘ã€Œå†å¹³è¡¡ (Rebalance)ã€å› 33% æ¬Šé‡ï¼Œå¯¦ç¾é«˜å‡ºä½é€²ã€‚</small>
""", unsafe_allow_html=True)

###############################################################
# è¨­å®šèˆ‡è³‡æ–™è®€å–
###############################################################
DATA_DIR = Path("data")

# å®šç¾©è³‡ç”¢é¸é …
ASSETS_REAL_ESTATE = {"VNQ (æˆ¿åœ°ç”¢ä¿¡è¨—ETF)": "VNQ", "IYR (ç¾åœ‹åœ°ç”¢ETF)": "IYR"}
ASSETS_STOCKS = {"QQQ (ç´æ–¯é”å…‹100)": "QQQ", "SPY (æ¨™æ™®500)": "SPY", "VTI (å…¨ç¾è‚¡å¸‚)": "VTI", "VT (å…¨çƒè‚¡å¸‚)": "VT"}
ASSETS_CASH = {"BIL (1-3æœˆåœ‹å‚µ)": "BIL", "SHV (çŸ­æœŸåœ‹å‚µ)": "SHV", "VGSH (çŸ­æœŸå…¬å‚µ)": "VGSH"}

def load_csv(symbol: str) -> pd.DataFrame:
    path = DATA_DIR / f"{symbol}.csv"
    if not path.exists():
        return pd.DataFrame()
    
    df = pd.read_csv(path, parse_dates=["Date"], index_col="Date")
    df = df.sort_index()
    
    # --- é—œéµä¿®æ”¹ï¼šå„ªå…ˆè®€å– Adj Close ä»¥è§£æ±ºé…æ¯å•é¡Œ ---
    if "Adj Close" in df.columns:
        df["Price"] = df["Adj Close"]
    elif "Close" in df.columns:
        df["Price"] = df["Close"]
    else:
        return pd.DataFrame()
        
    return df[["Price"]]

# å–å¾—å…±åŒæ™‚é–“å€é–“
def get_common_range(sym1, sym2, sym3):
    df1 = load_csv(sym1)
    df2 = load_csv(sym2)
    df3 = load_csv(sym3)
    if df1.empty or df2.empty or df3.empty:
        return dt.date(2015, 1, 1), dt.date.today()
    
    start = max(df1.index.min(), df2.index.min(), df3.index.min()).date()
    end = min(df1.index.max(), df2.index.max(), df3.index.max()).date()
    return start, end

###############################################################
# UI è¼¸å…¥å€
###############################################################
col1, col2, col3 = st.columns(3)
with col1:
    re_label = st.selectbox("ä¸‰åˆ†ä¹‹ä¸€ï¼šåœŸåœ° (REITs)", list(ASSETS_REAL_ESTATE.keys()))
    sym_re = ASSETS_REAL_ESTATE[re_label]
with col2:
    stk_label = st.selectbox("ä¸‰åˆ†ä¹‹ä¸€ï¼šäº‹æ¥­ (Stocks)", list(ASSETS_STOCKS.keys()), index=0)
    sym_stk = ASSETS_STOCKS[stk_label]
with col3:
    cash_label = st.selectbox("ä¸‰åˆ†ä¹‹ä¸€ï¼šç¾é‡‘ (Cash/Bonds)", list(ASSETS_CASH.keys()))
    sym_cash = ASSETS_CASH[cash_label]

s_min, s_max = get_common_range(sym_re, sym_stk, sym_cash)

col_d1, col_d2, col_d3 = st.columns(3)
with col_d1:
    start_date = st.date_input("é–‹å§‹æ—¥æœŸ", value=s_min, min_value=s_min, max_value=s_max)
with col_d2:
    end_date = st.date_input("çµæŸæ—¥æœŸ", value=s_max, min_value=s_min, max_value=s_max)
with col_d3:
    initial_capital = st.number_input("åˆå§‹æœ¬é‡‘", value=1_000_000, step=100_000)

col_c1, col_c2 = st.columns(2)
with col_c1:
    rebalance_freq = st.selectbox("å†å¹³è¡¡é »ç‡", ["æ¯å¹´ (Yearly)", "æ¯å­£ (Quarterly)", "ä¸å¹³è¡¡ (Buy & Hold)"], index=0)
with col_c2:
    # é‡å°æ²’æœ‰ Adj Close çš„è£œæ•‘æªæ–½
    cash_yield = st.number_input("è‹¥ç¾é‡‘CSVç„¡é…æ¯è³‡æ–™ï¼Œæ¨¡æ“¬å¹´åŒ–æ®–åˆ©ç‡(%)", 0.0, 10.0, 0.0, step=0.5, help="å¦‚æœä½ çš„BILè³‡æ–™åŒ…å«Adj Closeï¼Œè«‹è¨­ç‚º0ã€‚å¦‚æœåªæœ‰ç´”åƒ¹æ ¼ï¼Œå¯è¨­ç‚º3-4%è£œå„Ÿã€‚") / 100

###############################################################
# é‹ç®—é‚è¼¯
###############################################################
if st.button("é–‹å§‹å¡”æœ¨å¾·å›æ¸¬ âš–ï¸"):
    with st.spinner("è¨ˆç®—è³‡ç”¢é…ç½®ä¸­..."):
        # 1. è®€å–æ•¸æ“š
        df_re = load_csv(sym_re).loc[start_date:end_date]
        df_stk = load_csv(sym_stk).loc[start_date:end_date]
        df_cash = load_csv(sym_cash).loc[start_date:end_date]

        if df_re.empty or df_stk.empty or df_cash.empty:
            st.error("âŒ è³‡æ–™ä¸è¶³ï¼Œè«‹æª¢æŸ¥ CSV æª”æ¡ˆ")
            st.stop()

        # 2. åˆä½µèˆ‡è¨ˆç®—æ—¥å ±é…¬
        df = pd.DataFrame(index=df_re.index)
        df["P_RE"] = df_re["Price"]
        df = df.join(df_stk["Price"].rename("P_STK"), how="inner")
        df = df.join(df_cash["Price"].rename("P_CASH"), how="inner")
        
        # è¨ˆç®—å€‹åˆ¥è³‡ç”¢æ—¥å ±é…¬
        df["Ret_RE"] = df["P_RE"].pct_change().fillna(0)
        df["Ret_STK"] = df["P_STK"].pct_change().fillna(0)
        
        # ç¾é‡‘éƒ¨åˆ†ç‰¹æ®Šè™•ç†ï¼šå¦‚æœæœ‰è¨­æ¨¡æ“¬åˆ©ç‡ï¼Œä¸”åƒ¹æ ¼æ³¢å‹•æ¥µå°(å¯èƒ½æ˜¯æ²’æŠ“åˆ°é…æ¯)ï¼Œå‰‡ç–ŠåŠ åˆ©æ¯
        daily_yield = (1 + cash_yield) ** (1/252) - 1
        df["Ret_CASH_Raw"] = df["P_CASH"].pct_change().fillna(0)
        df["Ret_CASH"] = df["Ret_CASH_Raw"] + daily_yield

        # 3. å›æ¸¬æ ¸å¿ƒè¿´åœˆ (Rebalancing Logic)
        dates = df.index
        # åˆå§‹åŒ–ä¸‰å€‹ç±ƒå­çš„è³‡é‡‘
        holdings = {
            "RE": initial_capital / 3,
            "STK": initial_capital / 3,
            "CASH": initial_capital / 3
        }
        
        history_equity = []     # ç¸½è³‡ç”¢ç´€éŒ„
        history_weights = []    # æ¬Šé‡ç´€éŒ„ (ç”¨ä¾†ç•«åœ–)
        
        next_rebalance = dates[0] # ä¸‹ä¸€æ¬¡å†å¹³è¡¡æ—¥

        for i, d in enumerate(dates):
            # A. è¨ˆç®—ä»Šæ—¥æç›Š (é–‹ç›¤ä¾¿æŒæœ‰ï¼Œæ”¶ç›¤çµç®—)
            if i > 0:
                holdings["RE"] *= (1 + df["Ret_RE"].iloc[i])
                holdings["STK"] *= (1 + df["Ret_STK"].iloc[i])
                holdings["CASH"] *= (1 + df["Ret_CASH"].iloc[i])
            
            total_equity = sum(holdings.values())
            
            # B. æª¢æŸ¥æ˜¯å¦éœ€è¦å†å¹³è¡¡
            do_rebalance = False
            if rebalance_freq == "æ¯å¹´ (Yearly)":
                if d.year != dates[i-1].year if i > 0 else False: # è·¨å¹´
                    do_rebalance = True
            elif rebalance_freq == "æ¯å­£ (Quarterly)":
                if d.quarter != dates[i-1].quarter if i > 0 else False: # è·¨å­£
                    do_rebalance = True
            
            # C. åŸ·è¡Œå†å¹³è¡¡
            if do_rebalance:
                target_amount = total_equity / 3
                holdings["RE"] = target_amount
                holdings["STK"] = target_amount
                holdings["CASH"] = target_amount
            
            history_equity.append(total_equity)
            history_weights.append([
                holdings["RE"]/total_equity, 
                holdings["STK"]/total_equity, 
                holdings["CASH"]/total_equity
            ])

        df["Equity_Talmud"] = history_equity
        df["Return_Talmud"] = df["Equity_Talmud"].pct_change().fillna(0)
        
        # æ¬Šé‡è³‡æ–™è™•ç†
        w_arr = np.array(history_weights)
        df["W_RE"] = w_arr[:, 0]
        df["W_STK"] = w_arr[:, 1]
        df["W_CASH"] = w_arr[:, 2]

        # 4. å°ç…§çµ„ï¼šå–®ç´”æŒæœ‰ 100% è‚¡ç¥¨ / 100% æˆ¿åœ°ç”¢
        df["Equity_All_STK"] = initial_capital * (1 + df["Ret_STK"]).cumprod()
        df["Equity_All_RE"] = initial_capital * (1 + df["Ret_RE"]).cumprod()

        # ---------------- KPI è¨ˆç®—å‡½å¼ ----------------
        def calc_kpi(series_equity):
            final = series_equity.iloc[-1]
            ret = (final - initial_capital) / initial_capital
            dd = (series_equity / series_equity.cummax() - 1).min()
            
            # æ³¢å‹•ç‡ & å¤æ™® (ä½¿ç”¨æ—¥å ±é…¬)
            daily_ret = series_equity.pct_change().fillna(0)
            vol = daily_ret.std() * np.sqrt(252)
            sharpe = (daily_ret.mean() / daily_ret.std()) * np.sqrt(252) if daily_ret.std() > 0 else 0
            
            years = (series_equity.index[-1] - series_equity.index[0]).days / 365.25
            cagr = (final / initial_capital) ** (1/years) - 1 if years > 0 else 0
            
            return final, ret, cagr, dd, vol, sharpe

        kpi_tal = calc_kpi(df["Equity_Talmud"])
        kpi_stk = calc_kpi(df["Equity_All_STK"])
        
        # ==========================================================
        # è¦–è¦ºåŒ–å‘ˆç¾
        # ==========================================================
        
        # --- 1. è³‡é‡‘æ›²ç·šæ¯”è¼ƒ ---
        st.markdown("### ğŸ“ˆ å¡”æœ¨å¾· vs å…¨å€‰è‚¡ç¥¨ è³‡é‡‘æ›²ç·š")
        fig_eq = go.Figure()
        fig_eq.add_trace(go.Scatter(x=df.index, y=df["Equity_Talmud"], name="å¡”æœ¨å¾·ç­–ç•¥ (å¹³è¡¡)", line=dict(color="#636EFA", width=3)))
        fig_eq.add_trace(go.Scatter(x=df.index, y=df["Equity_All_STK"], name=f"å…¨å€‰ {stk_label}", line=dict(color="#EF553B", width=1.5, dash='dot')))
        fig_eq.add_trace(go.Scatter(x=df.index, y=df["Equity_All_RE"], name=f"å…¨å€‰ {re_label}", line=dict(color="#00CC96", width=1.5, dash='dot')))
        
        fig_eq.update_layout(template="plotly_white", height=450, hovermode="x unified")
        st.plotly_chart(fig_eq, use_container_width=True)

        # --- 2. æŒå€‰æ¬Šé‡è®ŠåŒ– (å †ç–Šåœ–) ---
        st.markdown("### ğŸ¥§ å‹•æ…‹æŒå€‰æ¬Šé‡è®ŠåŒ– (å¯è¦‹é«˜å‡ºä½é€²éç¨‹)")
        fig_w = go.Figure()
        fig_w.add_trace(go.Scatter(x=df.index, y=df["W_RE"], name="åœŸåœ° (REITs)", stackgroup='one', line=dict(width=0), fillcolor='rgba(0, 204, 150, 0.6)'))
        fig_w.add_trace(go.Scatter(x=df.index, y=df["W_STK"], name="è‚¡ç¥¨ (Stocks)", stackgroup='one', line=dict(width=0), fillcolor='rgba(239, 85, 59, 0.6)'))
        fig_w.add_trace(go.Scatter(x=df.index, y=df["W_CASH"], name="ç¾é‡‘ (Cash)", stackgroup='one', line=dict(width=0), fillcolor='rgba(99, 110, 250, 0.6)'))
        
        fig_w.update_layout(template="plotly_white", height=300, yaxis=dict(tickformat=".0%", title="æ¬Šé‡"), hovermode="x unified")
        st.plotly_chart(fig_w, use_container_width=True)

        # --- 3. KPI å¡ç‰‡å€ (CSS æ¨£å¼æ²¿ç”¨) ---
        st.markdown("""
        <style>
            .kpi-card { background-color: var(--secondary-background-color); border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
            .kpi-title { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
            .kpi-val { font-size: 1.8em; font-weight: bold; color: var(--text-color); }
            .kpi-sub { font-size: 0.8em; color: #666; }
        </style>
        """, unsafe_allow_html=True)

        def kpi_html(title, val, sub=""):
            return f"""<div class='kpi-card'><div class='kpi-title'>{title}</div><div class='kpi-val'>{val}</div><div class='kpi-sub'>{sub}</div></div>"""

        kp_c = st.columns(4)
        with kp_c[0]: st.markdown(kpi_html("æœŸæœ«ç¸½è³‡ç”¢", f"${kpi_tal[0]:,.0f}"), unsafe_allow_html=True)
        with kp_c[1]: st.markdown(kpi_html("å¹´åŒ–å ±é…¬ç‡ (CAGR)", f"{kpi_tal[2]:.2%}", f"vs è‚¡ç¥¨: {kpi_stk[2]:.2%}"), unsafe_allow_html=True)
        with kp_c[2]: st.markdown(kpi_html("æœ€å¤§å›æ’¤ (MDD)", f"{kpi_tal[3]:.2%}", f"vs è‚¡ç¥¨: {kpi_stk[3]:.2%}"), unsafe_allow_html=True)
        with kp_c[3]: st.markdown(kpi_html("å¤æ™®å€¼ (Sharpe)", f"{kpi_tal[5]:.2f}", f"vs è‚¡ç¥¨: {kpi_stk[5]:.2f}"), unsafe_allow_html=True)

        st.divider()
        
        # --- 4. è©³ç´°æ•¸æ“šæ¯”è¼ƒè¡¨ ---
        st.markdown("### ğŸ“Š è©³ç´°ç¸¾æ•ˆå°ç…§è¡¨")
        metrics_data = {
            "ç­–ç•¥": ["å¡”æœ¨å¾·ç­–ç•¥", f"å…¨å€‰ {stk_label}", f"å…¨å€‰ {re_label}"],
            "æœŸæœ«è³‡ç”¢": [kpi_tal[0], kpi_stk[0], calc_kpi(df["Equity_All_RE"])[0]],
            "CAGR": [kpi_tal[2], kpi_stk[2], calc_kpi(df["Equity_All_RE"])[2]],
            "MDD": [kpi_tal[3], kpi_stk[3], calc_kpi(df["Equity_All_RE"])[3]],
            "æ³¢å‹•ç‡": [kpi_tal[4], kpi_stk[4], calc_kpi(df["Equity_All_RE"])[4]],
            "å¤æ™®å€¼": [kpi_tal[5], kpi_stk[5], calc_kpi(df["Equity_All_RE"])[5]],
        }
        df_metrics = pd.DataFrame(metrics_data).set_index("ç­–ç•¥")
        
        # æ ¼å¼åŒ–è¡¨æ ¼
        st.dataframe(
            df_metrics.style.format({
                "æœŸæœ«è³‡ç”¢": "${:,.0f}",
                "CAGR": "{:.2%}",
                "MDD": "{:.2%}",
                "æ³¢å‹•ç‡": "{:.2%}",
                "å¤æ™®å€¼": "{:.2f}"
            }).highlight_max(subset=["æœŸæœ«è³‡ç”¢", "CAGR", "å¤æ™®å€¼"], color='rgba(0, 255, 0, 0.1)')
              .highlight_min(subset=["MDD", "æ³¢å‹•ç‡"], color='rgba(0, 255, 0, 0.1)'), 
            use_container_width=True
        )
